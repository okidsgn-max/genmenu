<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор менюборда</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
    :root {
        --primary: #04C9B0;
        --primary-hover: #139483;
        --primary-active: #4DAB9E;
        --primary-light: rgba(4, 201, 176, 0.1);
        --text-main: #FFFFFF;
        --text-secondary: #b2b2b2;
        --text-inactive: #667099;
        --border: #000000;
        --background-light: #191C1F;
        --background-dark: #090909;
        --placeholder: #667099;
        --border-radius: 8px;
        --transition-fast: 0.15s;
        --transition-medium: 0.3s;
        --transition-slow: 0.5s;
        --grid-bg-color: transparent;
        --cell-bg-color: #ffffff;
        --menu-bg-color: #ffffff;
        --card-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        --card-hover-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    [contenteditable] {
        outline: 2px solid transparent;
        transition: outline-color 0.2s;
        padding: 2px 4px;
        border-radius: 4px;
    }

    [contenteditable]:focus, [contenteditable]:hover {
        outline-color: var(--primary);
        background: rgba(0,0,0,0.5);
        box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    
    body {
        font-family: 'Inter', sans-serif;
        color: var(--text-main);
        background-color: var(--background-dark);
        padding: 0;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .main-container {
        display: flex;
        flex: 1;
        gap: 24px;
        overflow: hidden;
        height: 100%;
        padding: 24px;
    }
    
    .btn {
        font-family: 'Inter', sans-serif;
        font-weight: 400;
        font-size: 11pt;
        line-height: 20px;
        border-radius: var(--border-radius);
        padding: 12px 16px;
        cursor: pointer;
        transition: all var(--transition-medium);
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background-color: var(--primary);
        color: #FFFFFF;
        width: 100%;
    }

    #download-png-btn {
        background: linear-gradient(to right, #05B7A0, #083832);
    }
    #download-png-btn:hover {
        filter: brightness(1.1);
        transform: translateY(-1px);
    }
    
    #confirm-aspect-ratio, #limit-modal-close {
        background: linear-gradient(to right, #05B7A0, #083832);
    }
    #confirm-aspect-ratio:hover, #limit-modal-close:hover {
       filter: brightness(1.1);
    }


    .controls-footer .btn {
        border-radius: 30px;
    }

    .btn:hover { background-color: var(--primary-hover); transform: translateY(-1px); }
    .btn:active { background-color: var(--primary-active); transform: translateY(0); }
    
   .btn-secondary {
    background-color: #000000;
    color: #ffffff;
    border: 1.5px solid #C6C6C6;
    }
   .btn-secondary:hover, .btn-secondary:active {
    background-color: #ffffff;
    color: #000000;
    border-color: #ffffff;
    }

    #confirm-aspect-ratio, #export-excel-btn, #bg-image-container .btn, #menu-bg-image-container .btn, .drop-area .btn, #cancel-mp4, #save-mp4, #limit-modal-close {
        border-radius: 30px;
    }
    
    .btn-small { padding: 4px 8px; font-size: 12px; width: auto; margin: 0; }
    
    .input, .select {
        font-size: 14px;
        font-weight: 500;
        line-height: 20px;
        padding: 12px 14px;
        border: 1px solid var(--border);
        border-radius: var(--border-radius);
        background-color: var(--background-light);
        color: var(--text-secondary);
        outline: none;
        width: 100%;
        box-sizing: border-box;
        transition: all var(--transition-medium);
        margin-bottom: 16px;
    }
    
    .input:hover, .select:hover { border-color: var(--primary-hover); }
    
    .select {
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='16' height='16' viewBox='0 0 16 16' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M4 6L8 10L12 6' stroke='%23FFFFFF' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        cursor: pointer;
    }
    
    .input:focus, .select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(4, 201, 176, 0.15); }
    
    .checkbox-group { display: flex; align-items: center; margin-bottom: 16px; cursor: pointer; }
    .checkbox-group label { color: var(--text-secondary); font-weight: 400; font-size: 14px; cursor: pointer; margin-bottom: 0; }
    .checkbox-group input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 18px;
        height: 18px;
        margin-right: 10px;
        border-radius: 4px;
        border: 2px solid #808080;
        background-color: transparent;
        position: relative;
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    .checkbox-group input[type="checkbox"]:hover {
        border-color: var(--primary);
    }
    .checkbox-group input[type="checkbox"]:checked {
        border-color: #139483;
        background-color: #139483;
    }
    .checkbox-group input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 10px;
        border: solid white;
        border-width: 0 2px 2px 0;
        transform: translate(-50%, -60%) rotate(45deg);
    }

    .features-group { display: flex; gap: 15px; flex-wrap: wrap; }
    
    .controls-panel {
        background: var(--background-dark);
        padding: 24px;
        border-radius: 16px;
        width: 380px;
        display: flex;
        flex-direction: column;
        height: 100%;
        flex-shrink: 0;
        box-shadow: var(--card-shadow);
        border: 1px solid #00b398;
    }
    
    .controls-content {
        flex: 1; overflow-y: auto; padding-right: 10px; scrollbar-width: thin; scrollbar-color: #1f1f1f transparent;
    }
    
    .controls-content::-webkit-scrollbar { width: 6px; }
    .controls-content::-webkit-scrollbar-thumb { background-color: #1f1f1f; border-radius: 3px; }
    .controls-footer { padding-top: 16px; border-top: 1px solid var(--border); margin-top: auto; }
    
    .tab-buttons {
        display: flex; margin-bottom: 14px; position: sticky; top: 0; background: var(--background-dark); z-index: 10;
        border-radius: var(--border-radius); padding: 2px; background: #191C1F;
    }
    
    .tab-btn {
        display: flex; align-items: center; padding: 10px 14px; background: none; border: none; cursor: pointer;
        font-weight: 500; transition: all var(--transition-medium); color: #FFFFFF;
        border-radius: 8px; flex: 1; justify-content: center;
    }
    
    .tab-btn img {
        width: 24px;
        height: 24px;
        margin-right: 2px;
        filter: brightness(0) invert(1);
    }
    
    .tab-btn.active {
        color: #00b398;
        background: var(--background-dark);
        box-shadow: none;
    }
    .tab-btn.active img {
        filter: invert(48%) sepia(98%) saturate(1499%) hue-rotate(130deg) brightness(94%) contrast(101%);
    }
    
    .control-group { border: 1px solid var(--border); border-radius: var(--border-radius); margin-bottom: 16px; }
    
    .control-group summary {
        font-size: 16px; font-weight: 400; color: var(--text-main); padding: 12px 16px; cursor: pointer; list-style: none;
        display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s ease, color 0.2s ease;
    }
    .control-group[open] summary {
        color: #00b398;
    }
    .control-group summary:hover { background-color: var(--primary-light); }
    .control-group summary::-webkit-details-marker { display: none; }
    .control-group summary::after {
        content: '+';
        font-size: 28px;
        font-weight: 400;
        color: #FFFFFF;
        transition: transform var(--transition-medium) ease-out, color 0.2s ease;
        transform: rotate(0deg);
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .control-group[open] summary::after {
        content: '−';
        transform: rotate(180deg);
        color: #00b398;
    }
    .control-group-content { padding: 0 16px 16px; }
    .control-group-content p {
        color: var(--text-secondary);
        font-size: 10pt;
    }
    
    label { display: block; margin-bottom: 8px; font-weight: 400; font-size: 14px; color: var(--text-main); }
    
    .preview-wrapper {
        flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; min-width: 0;
        overflow: hidden; background: transparent; border-radius: var(--border-radius);
        border: 1px solid var(--border); padding: 20px;
    }
    
    .preview-container {
        width: 100%;
        max-height: 100%;
        height: auto;
        aspect-ratio: 16/9;
        background: transparent;
        border-radius: var(--border-radius);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        border: 0px solid var(--border);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    
    .menu-preview {
        width: 100%; height: 100%; position: relative; background-color: var(--menu-bg-color);
        display: flex; flex-direction: column; justify-content: flex-start; align-items: stretch; overflow: hidden;
        background-size: cover;
        background-position: center;
    }
    
    .menu-list-template { width: 100%; height: 100%; display: flex; flex-direction: column; overflow: hidden; }
    .menu-items-container { flex: 1; overflow-y: auto; display: block; padding: 30px; }
    .menu-items-container.two-columns { column-count: 2; column-gap: 40px; }
    .menu-section { break-inside: avoid; margin-bottom: 30px; }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--border);
    }

    .section-title {
        font-family: var(--category-font-family);
        font-size: var(--category-font-size);
        font-weight: 700;
        color: var(--category-font-color);
        flex-grow: 1;
        min-width: 0;
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    
    .menu-item { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed var(--border); }
    .item-content { flex-grow: 1; min-width: 0; }
    
    .item-name {
        font-family: var(--item-font-family);
        font-weight: 500;
        font-size: var(--item-font-size);
        color: #000000;
        margin-bottom: 2px;
    }

    .item-description { font-family: var(--desc-font-family); font-size: var(--desc-font-size); color: var(--desc-font-color); margin-bottom: 5px; font-weight: 300; }
    .item-price {
        font-family: var(--item-font-family); font-weight: 700; font-size: var(--item-font-size); color: var(--item-font-color);
        white-space: nowrap; margin-left: 20px; text-align: right; flex-shrink: 0;
    }

    .volume-price-container {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        flex-wrap: nowrap;
    }

    .volume-price {
        display: inline-flex;
        gap: 4px;
        align-items: baseline;
    }
    
    .menu-grid-template, .menu-grid-template-3x2 { width: 100%; height: 100%; display: grid; gap: 15px; padding: 15px; background-color: var(--grid-bg-color); }
    .menu-grid-template { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
    .menu-grid-template-3x2 { grid-template-columns: 1fr 1fr 1fr; grid-template-rows: 1fr 1fr; }
    
    .grid-cell {
        background-color: var(--cell-bg-color); border-radius: var(--border-radius); display: flex;
        position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }
    .grid-gradient-overlay {
        position: absolute; left: 0; top: 0; width: 100%; height: 100%;
        background: linear-gradient(to right, rgba(0,0,0, var(--grid-gradient-opacity, 0.4)) 0%, rgba(0,0,0,0) 60%);
        z-index: 2; pointer-events: none; border-radius: var(--border-radius);
    }
    .grid-cell-content { 
        flex: 2; padding: 15px; display: flex; flex-direction: column; gap: 5px; z-index: 3; min-width: 0; 
        height: 100%;
    }
    .grid-cell .item-name { 
        word-break: break-word; 
    }
    .grid-cell .item-name, .grid-cell .item-description { color: var(--item-font-color); }
    .grid-cell .item-description { 
        flex-grow: 1; 
        color: var(--desc-font-color);
        word-break: break-word;
        overflow: hidden;
    }
    .grid-cell .item-price { text-align: left; margin-left: 0; font-family: var(--price-font-family); font-size: var(--price-font-size); color: var(--price-font-color); margin-top: auto; }
    
    .grid-cell .volume-price-container {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
        gap: 0px;
        height: 100%;
        flex-wrap: wrap;
    }

    .grid-cell .volume-price {
        font-family: var(--price-font-family);
        font-size: var(--price-font-size);
        color: var(--price-font-color);
        font-weight: 700;
    }

    .grid-cell .volume-price span[data-field^="volume"] {
        font-weight: 500;
    }
    
    .grid-cell .item-photo-container {
        flex: 1.2;
        background: var(--cell-bg-color);
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        z-index: 1;
        position: relative;
    }
    .grid-cell .item-photo {
        width: 100%;
        height: 100%;
        background-size: auto 100%;
        background-position: center;
        background-repeat: no-repeat;
        cursor: move;
    }
    .grid-cell .upload-photo-btn {
        font-size: 30px; cursor: pointer; border: none; background: rgba(0, 0, 0, 0.3); width: 40px; height: 40px;
        border-radius: 50%; color: #090909; transition: all var(--transition-medium); position: absolute;
        top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;
    }
    .grid-cell .upload-photo-btn:hover { background: rgba(0, 0, 0, 0.5); transform: translate(-50%, -50%) scale(1.05); }

    .promo-template {
        position: relative; width: 100%; height: 100%; overflow: hidden; background-size: cover;
        background-position: center; background-color: #1A1D1F; display: flex; flex-direction: column; justify-content: center;
    }
    .promo-content {
        position: relative; z-index: 2; height: 100%; display: flex; flex-direction: column;
        padding: 40px; box-sizing: border-box; text-align: var(--promo-text-align, left);
    }
    .promo-title {
        font-size: var(--promo-title-font-size); font-family: var(--promo-title-font-family); color: var(--promo-title-font-color);
        font-weight: 600; margin-bottom: 20px; line-height: 1.1; display: inline-flex; align-items: flex-start; gap: 15px;
    }
    .promo-text { font-size: var(--promo-text-font-size); font-family: var(--promo-text-font-family); color: var(--promo-text-font-color); margin-bottom: 30px; line-height: 1.3; }
    .promo-comment {
        font-family: var(--desc-font-family); font-size: 10px; color: var(--promo-text-font-color); margin-top: auto;
        padding-top: 15px; width: 100%; box-sizing: border-box; align-self: flex-end; opacity: 0.8;
    }
    .promo-price-container { display: inline-flex; align-items: center; gap: 20px; }
    .promo-content > div:first-child { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; }
    .promo-content[style*="text-align: center"] .promo-title, .promo-content[style*="text-align: center"] .promo-price-container { margin-left: auto; margin-right: auto; }
    .promo-content[style*="text-align: right"] .promo-title, .promo-content[style*="text-align: right"] .promo-price-container { margin-left: auto; }
    .promo-price { font-size: var(--promo-price-font-size); font-family: var(--promo-price-font-family); color: var(--promo-price-font-color); font-weight: bold; }
    .promo-discount {
        font-size: calc(var(--promo-price-font-size) * 0.7); font-family: var(--promo-price-font-family); color: var(--discount-font-color);
        font-weight: bold; background: var(--discount-bg-color); padding: 5px 10px; border-radius: 20px;
    }
    .promo-icon-wrapper {
        display: inline-flex; align-items: center; justify-content: center;
        padding: 8px; border-radius: 8px; 
        background-color: transparent;
    }
    .promo-icon { height: 1.2em; width: auto; }
    
    .combined-template { display: grid; grid-template-columns: 1fr 1fr; width: 100%; height: 100%; overflow: hidden; position: relative; }
    .combined-promo-part { position: relative; z-index: 1; background-size: cover; background-position: center; overflow: hidden; color: white; }
    .combined-menu-part { 
        z-index: 2; 
        grid-column: 1 / 2; 
        background-color: var(--menu-bg-color); 
        position: relative; 
        overflow: hidden;
        display: flex;
        flex-direction: column;
        background-size: cover;
        background-position: center;
    }
    .combined-menu-part .menu-grid-template, .combined-menu-part .menu-grid-template-3x2 {
        flex-grow: 1;
    }
    .combined-menu-part .grid-cell {
        min-height: 0;
    }
    .combined-menu-part .item-description {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .menu-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background-color: var(--menu-bg-color); flex-shrink: 0; }
    .menu-grid-category-title { font-family: var(--category-font-family); font-size: var(--category-font-size); font-weight: 700; color: var(--category-font-color); }
    .menu-date { font-family: var(--item-font-family); font-size: 14px; color: var(--text-secondary); background-color: transparent; padding: 5px 10px; border-radius: 4px; }
    
    .modal-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex;
        justify-content: center; align-items: center; z-index: 1000;
        backdrop-filter: blur(5px);
    }
    .modal { 
        background: var(--background-dark); padding: 24px; border-radius: 8px; width: 400px; 
        max-width: 90%; box-shadow: var(--card-hover-shadow); border: 1px solid #4D4D4D; 
    }
    .modal-title { font-size: 16px; font-weight: 400; margin-bottom: 20px; color: var(--text-main); text-align: center; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; border-radius:30px }
    
    .aspect-ratio-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .aspect-ratio-btn { padding: 12px; border: 1px solid var(--border); border-radius: var(--border-radius); cursor: pointer; text-align: center; transition: all var(--transition-medium); color: var(--text-secondary); background: var(--background-light); }
    .aspect-ratio-btn.active { border-color: var(--primary); background-color: var(--primary-light); color: var(--primary); }
    
    .loading-overlay {
        position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; justify-content: center;
        align-items: center; z-index: 1000; color: white; font-size: 16px; flex-direction: column; text-align: center;
    }
    .spinner {
        border: 5px solid #444; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px;
        animation: spin 1s linear infinite; margin-bottom: 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .drop-area {
        border: 2px dashed var(--border);
        border-radius: var(--border-radius);
        padding: 24px;
        text-align: center;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all var(--transition-medium);
        background-color: var(--background-light);
        color: var(--text-secondary);
        font-size: 10pt;
    }
    .drop-area .btn {
        width: auto;
        padding: 4px 16px;
        margin-top: 10px;
    }

    .drop-area:hover, .drop-area.highlight { border-color:#191C1F); background: #191C1F; }
    .file-info { font-size: 10px; color: #C6C6C6); margin-top: 5px; }

    .layout-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
    .layout-btn {
        display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px 8px;
        border: 1px solid var(--border); border-radius: var(--border-radius); cursor: pointer;
        transition: all var(--transition-medium); background: var(--background-light); font-size: 12px; font-weight: 500; color: var(--text-secondary);
    }
    .layout-btn:hover { border-color: var(--primary); background: var(--primary-light); color: var(--text-main); }
    .layout-btn.active { border-color: var(--background-dark); background: var(--primary); color: white; }
    .layout-btn img { width: 24px; height: 24px; margin-bottom: 8px; filter: brightness(0.8); }
    .layout-btn.active img { filter: brightness(0) invert(1); }

    .color-picker-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; align-items: center; }
    .color-picker-item label { font-size: 12px; text-align: center; margin-bottom: 6px; }
    .color-picker-item input[type="color"] { 
        width: 100%; height: 32px; padding: 0; background: none; cursor: pointer;
        border-radius: 4px; border: 1px solid var(--border);
    }
    .grid-color-item { display: none; }
    
    .setting-row { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
    .setting-row .select { flex: 2; margin-bottom: 0; }
    .setting-row .input { flex: 1; margin-bottom: 0; }
    .setting-row input[type="color"] {
        width: 40px; height: 40px; padding: 0; background: none; cursor: pointer;
        border-radius: 16px; border: 1px solid var(--border);
    }

    .slider-container { width: 100%; margin-bottom: 16px; }
    .slider-container input[type="range"] { width: 100%; height: 6px; -webkit-appearance: none; background: #2a2e30; border-radius: 4px; outline: none; }
    .slider-container input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%;
        background: var(--primary); cursor: pointer; transition: all var(--transition-medium);
    }
    .slider-container input[type="range"]::-moz-range-thumb { width: 18px; height: 18px; border-radius: 50%; background: var(--primary); cursor: pointer; }
    .slider-value { text-align: center; font-size: 14px; color: var(--text-secondary); margin-top: 5px; }
    
    .header-title { 
        font-size: 24px; 
        font-weight: 300; 
        margin-bottom: 20px; 
        color: var(--text-main);
    }
    
    .toggle-switch {
        display: flex; border-radius: var(--border-radius); background: #191C1F; padding: 2px; margin-bottom: 16px;
    }
    .toggle-btn {
        flex: 1; padding: 8px 12px; border: none; background: transparent; cursor: pointer; font-weight: 500;
        color: var(--text-secondary); border-radius: 8px; transition: all var(--transition-medium);
    }
    .toggle-btn.active { background: var(--background-dark); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

    .manual-editor .input { margin-bottom: 10px; }
    .manual-item-list { margin-bottom: 15px; }
    .manual-item {
        display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 8px;
        margin-bottom: 5px; background: var(--background-light); font-size: 13px; color: var(--text-secondary);
    }
    .manual-item-name { flex-grow: 1; font-weight: 500; color: var(--text-main); }
    .manual-item-actions button { background: none; border: none; cursor: pointer; padding: 4px; }
    .add-item-area {
        border: 2px dashed var(--border);
        border-radius: var(--border-radius);
        padding: 8px;
        text-align: center;
        margin: 10px 0 15px 0;
        cursor: pointer;
        transition: all var(--transition-medium);
        background-color: var(--background-light);
        color: var(--text-secondary);
        font-weight: 500;
        font-size: 10pt;
    }
    .add-item-area:hover {
        border-color: var(--primary);
        background: var(--primary-light);
        color: var(--primary);
    }

    .btn-group { display: flex; gap: 10px; }
    
    .combined-template .promo-content { padding: 25px; justify-content: flex-start; }
    .combined-template .promo-content > div:first-child { justify-content: flex-start; }
    .combined-template .promo-title { font-size: calc(var(--promo-title-font-size) * 0.4); margin-bottom: 10px; gap: 10px; }
    .combined-template .promo-text { font-size: calc(var(--promo-text-font-size) * 0.4); margin-bottom: 15px; }
    .combined-template .promo-price-container { gap: 10px; margin-top: auto; }
    .combined-template .promo-price { font-size: calc(var(--promo-price-font-size) * 0.45); }
    .combined-template .promo-discount { font-size: calc(var(--promo-price-font-size) * 0.3); padding: 3px 8px; }
    .combined-template .promo-icon-wrapper { padding: 4px; border-radius: 4px; }
    .combined-template .promo-icon { height: 1em; }
    .combined-template .promo-comment { display: none; }
    
    .combined-template .combined-menu-part .grid-cell-content .item-name { color: var(--item-font-color); }
    .combined-template .combined-menu-part .grid-cell-content .item-description { color: var(--desc-font-color); }
    .combined-template .combined-menu-part .grid-cell-content .item-price { color: var(--item-font-color); }
    .combined-template .combined-promo-part .grid-cell-content .item-name,
    .combined-template .combined-promo-part .grid-cell-content .item-description,
    .combined-template .combined-promo-part .grid-cell-content .item-price { color: white; text-shadow: 1px 1px 3px rgba(0,0,0,0.7); }

    .combined-template .menu-items-container { padding: 15px; gap: 10px; }
    .combined-template .menu-item { margin-bottom: 10px; padding-bottom: 10px; }
    .combined-template .item-name { font-size: calc(var(--item-font-size) * 0.9); }
    .combined-template .item-description { font-size: calc(var(--desc-font-size) * 0.9); }
    .combined-template .item-price { font-size: calc(var(--item-font-size) * 0.9); }

    .combined-template .grid-cell { display: block; position: relative; overflow: visible; }
    .combined-template .grid-cell-content { height: 100%; width: 100%; position: relative; z-index: 2; }
    .combined-template .grid-cell .item-photo-container { position: absolute; right: 0; bottom: 0; width: 50%; height: 50%; flex: none; z-index: 1; }
    .combined-template .grid-cell::after { display: none; }

    .menu-date.auto-contrast { color: var(--date-contrast-color, #FFFFFF); }
    
    /* Styles for Resizing Images */
    .resizable-container.selected {
        outline: 2px solid var(--primary);
        box-shadow: 0 0 10px rgba(4, 201, 176, 0.5);
    }
    .resize-handle {
        position: absolute;
        width: 14px;
        height: 14px;
        background: var(--primary);
        border: 2px solid white;
        border-radius: 50%;
        z-index: 12;
        display: none;
    }
    .resize-handle.br { bottom: -7px; right: -7px; cursor: se-resize; }
    .resize-handle.bl { bottom: -7px; left: -7px; cursor: ne-sw-resize; }
    .resize-handle.tr { top: -7px; right: -7px; cursor: ne-sw-resize; }
    .resize-handle.tl { top: -7px; left: -7px; cursor: se-resize; }

    .resizable-container.selected .resize-handle {
        display: block;
    }
    .promo-template.resizable-container, .combined-promo-part.resizable-container {
        cursor: move;
    }
     .delete-photo-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 32px;
        height: 32px;
        background: rgba(25, 28, 31, 0.7);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        z-index: 15;
        opacity: 0;
        transition: opacity 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .item-photo-container:hover .delete-photo-btn {
        opacity: 1;
    }
    .delete-photo-btn img {
        width: 20px;
        height: 20px;
        filter: brightness(0) invert(0.8);
    }

    /* Styles for List SML Prices */
    .list-price-headers {
        display: flex;
        justify-content: flex-end;
        gap: 12px; /* Match volume-price-container gap */
        margin-bottom: 0;
        padding-right: 0; /* Align with prices */
        flex-shrink: 0;
    }
    .list-price-headers > span {
        font-family: var(--category-font-family);
        font-weight: 700;
        font-size: var(--item-font-size);
        color: var(--category-font-color);
        width: 70px; /* Fixed width for alignment */
        text-align: right;
    }
    .menu-list-template .menu-item .volume-price {
        width: 70px; /* Match header width */
        justify-content: flex-end;
    }
    .menu-list-template .menu-item .volume-price span[data-field^="volume"] {
        display: none;
    }
    .menu-header.list-view-header {
        position: absolute;
        bottom: 15px;
        right: 20px;
        width: auto;
        padding: 0;
        background-color: transparent !important;
        z-index: 10;
        flex-shrink: 1;
    }
</style>
</head>
<body>
    <div class="main-container">
        <div class="controls-panel">
            <h1 class="header-title">Генератор менюборда</h1>

            <div class="tab-buttons">
                <button class="tab-btn active" data-tab="menu"><img src="menu-w.svg" alt="Меню"> Меню</button>
                <button class="tab-btn" data-tab="promo"><img src="acii-w.svg" alt="Акция"> Акция</button>
                <button class="tab-btn" data-tab="combined"><img src="ac+m-w.svg" alt="Меню+Акция"> Меню+Акция</button>
            </div>

            <div class="controls-content">
                <div id="menu-controls">
                    <details class="control-group">
                        <summary>Шаг 1: Содержимое</summary>
                        <div class="control-group-content">
                            <div class="toggle-switch">
                                <button id="toggle-manual" class="toggle-btn" data-mode="manual">Ввести вручную</button>
                                <button id="toggle-upload" class="toggle-btn active" data-mode="upload">Загрузить файл</button>
                            </div>
                            
                            <div id="upload-mode-content">
                                <div class="drop-area" id="menu-drop-area">
    Перетащите файл Excel или TXT или
    <button class="btn btn-secondary" onclick="document.getElementById('file-input').click()">Выберите файл</button>
    <input type="file" id="file-input" accept=".xlsx, .xls, .csv, .txt" style="display: none;">
    <div class="file-info" id="menu-file-info">Файл не выбран</div>
</div>
                            </div>

                            <div id="manual-mode-content" style="display: none;" class="manual-editor">
                               <p style="margin-bottom: 15px;">Нажимая на поля текста в превью, вы можете заполнить свое меню, а после сохранить страницу как Excel.</p>
                               <div id="manual-item-list"></div>
                               <div id="add-manual-item-btn" class="add-item-area">+ Добавить позицию</div>
                               <button id="export-excel-btn" class="btn btn-secondary">Сохранить как Excel</button>
                            </div>
                        </div>
                    </details>

                    <details class="control-group">
                         <summary>Шаг 2: Структура и вид</summary>
                         <div class="control-group-content">
                             <label>Макет</label>
                             <div class="layout-buttons" id="layout-buttons">
                                <button class="layout-btn active" data-layout="grid">
                                    <img src="4.svg" alt="Layout 2x2">
                                    2x2
                                </button>
                                <button class="layout-btn" data-layout="grid3x2">
                                    <img src="6.svg" alt="Layout 3x2">
                                    3x2
                                </button>
                                <button class="layout-btn" data-layout="list">
                                    <img src="spisok.svg" alt="Layout List">
                                    Список
                                </button>
                            </div>

                            <div class="checkbox-group" style="margin-top: 15px;">
                                <input type="checkbox" id="show-description-checkbox" checked>
                                <label for="show-description-checkbox">Показывать описание блюд</label>
                            </div>
                             <div class="checkbox-group">
                                <input type="checkbox" id="show-date-checkbox" checked>
                                <label for="show-date-checkbox">Показывать текущую дату</label>
                            </div>
                             <div class="checkbox-group">
                                <input type="checkbox" id="show-sml-prices-checkbox">
                                <label for="show-sml-prices-checkbox">Показывать цены S,M,L</label>
                            </div>
                         </div>
                    </details>

                    <details class="control-group">
                        <summary>Шаг 3: Оформление</summary>
                        <div class="control-group-content">
                            <div>
                                <label>Цвета</label>
                                <div class="color-picker-row">
                                    <div class="color-picker-item">
                                        <label style="text-align: left;">Фон меню</label>
                                        <input type="color" id="menu-bg-color-picker" value="#ffffff">
                                    </div>
                                    <div class="color-picker-item grid-color-item">
                                        <label style="text-align: left;">Фон ячейки</label>
                                        <input type="color" id="cell-bg-color-picker" value="#ffffff">
                                    </div>
                                    <div class="color-picker-item grid-color-item">
                                        <label>Затемнение ячейки</label>
                                        <div class="slider-container" style="margin-bottom:0; padding-top: 5px;">
                                            <input type="range" id="grid-gradient-slider" min="0" max="100" value="10">
                                            <div class="slider-value" id="grid-gradient-value">10%</div>
                                        </div>
                                    </div>
                                </div>
                                <div id="menu-bg-options" style="margin-top: 15px;">
                                    <label>Фон для меню</label>
                                    <select id="menu-bg-type-select" class="select">
                                        <option value="color">Сплошной цвет</option>
                                        <option value="image">Загрузить изображение</option>
                                    </select>
                                    <div id="menu-bg-image-container" style="display: none; margin-top: 10px;">
                                        <button class="btn btn-secondary" onclick="document.getElementById('menu-background-upload').click()">Выберите файл</button>
                                        <input type="file" id="menu-background-upload" accept="image/*" style="display: none;">
                                        <div class="file-info" id="menu-bg-file-info">Изображение не загружено</div>
                                    </div>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <label>Шрифт категорий</label>
                                <div class="setting-row">
                                    <select id="category-font-select" class="select">
                                        <option value="'Roboto', sans-serif">Roboto</option>
                                        <option value="'Open Sans', sans-serif">Open Sans</option>
                                        <option value="'PT Sans', sans-serif">PT Sans</option>
                                        <option value="'Playfair Display', serif">Playfair Display</option>
                                        <option value="'Montserrat', sans-serif">Montserrat</option>
                                        <option value="'Oswald', sans-serif">Oswald</option>
                                        <option value="'Raleway', sans-serif">Raleway</option>
                                        <option value="'Nunito', sans-serif">Nunito</option>
                                        <option value="'Rubik', sans-serif">Rubik</option>
                                        <option value="'Cormorant', serif">Cormorant</option>
                                    </select>
                                    <input type="number" id="category-font-size" class="input" value="24" min="10" max="100">
                                    <input type="color" id="category-color-picker" value="#00b398">
                                </div>
                            </div>
                             <div style="margin-top: 15px;">
                                <label>Шрифт пунктов</label>
                                <div class="setting-row">
                                    <select id="item-font-select" class="select">
                                        <option value="'Roboto', sans-serif">Roboto</option>
                                        <option value="'Open Sans', sans-serif">Open Sans</option>
                                        <option value="'PT Sans', sans-serif">PT Sans</option>
                                        <option value="'Playfair Display', serif">Playfair Display</option>
                                        <option value="'Montserrat', sans-serif">Montserrat</option>
                                        <option value="'Oswald', sans-serif">Oswald</option>
                                        <option value="'Raleway', sans-serif">Raleway</option>
                                        <option value="'Nunito', sans-serif">Nunito</option>
                                        <option value="'Rubik', sans-serif">Rubik</option>
                                        <option value="'Cormorant', serif">Cormorant</option>
                                    </select>
                                    <input type="number" id="item-font-size" class="input" value="16" min="10" max="100">
                                    <input type="color" id="item-color-picker" value="#000000">
                                </div>
                            </div>
                             <div style="margin-top: 15px;">
                                <label>Шрифт описания</label>
                                <div class="setting-row">
                                    <select id="desc-font-select" class="select">
                                        <option value="'Roboto', sans-serif">Roboto</option>
                                        <option value="'Open Sans', sans-serif">Open Sans</option>
                                        <option value="'PT Sans', sans-serif">PT Sans</option>
                                        <option value="'Playfair Display', serif">Playfair Display</option>
                                        <option value="'Montserrat', sans-serif">Montserrat</option>
                                        <option value="'Oswald', sans-serif">Oswald</option>
                                        <option value="'Raleway', sans-serif">Raleway</option>
                                        <option value="'Nunito', sans-serif">Nunito</option>
                                        <option value="'Rubik', sans-serif">Rubik</option>
                                        <option value="'Cormorant', serif">Cormorant</option>
                                    </select>
                                    <input type="number" id="desc-font-size" class="input" value="14" min="8" max="100">
                                    <input type="color" id="desc-color-picker" value="#A9B0C9">
                                </div>
                            </div>
                            <div class="grid-color-item" style="margin-top: 15px;">
                                <label>Шрифт стоимости (для сетки)</label>
                                <div class="setting-row">
                                    <select id="price-font-select" class="select">
                                        <option value="'Roboto', sans-serif">Roboto</option>
                                        <option value="'Open Sans', sans-serif">Open Sans</option>
                                        <option value="'Montserrat', sans-serif">Montserrat</option>
                                        <option value="'Oswald', sans-serif">Oswald</option>
                                    </select>
                                    <input type="number" id="price-font-size" class="input" value="10" min="10" max="100">
                                    <input type="color" id="price-color-picker" value="#00b398">
                                </div>
                            </div>
                        </div>
                    </details>
                </div>
                
                <div id="promo-controls" style="display: none;">
                    <details class="control-group" open>
                        <summary>Настройки текста</summary>
                        <div class="control-group-content">
                            <label>Заголовок акции</label>
                            <div class="setting-row">
                                <select id="promo-title-font-select" class="select">
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Open Sans', sans-serif">Open Sans</option>
                                    <option value="'PT Sans', sans-serif">PT Sans</option>
                                    <option value="'Playfair Display', serif">Playfair Display</option>
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Oswald', sans-serif">Oswald</option>
                                    <option value="'Raleway', sans-serif">Raleway</option>
                                    <option value="'Nunito', sans-serif">Nunito</option>
                                    <option value="'Rubik', sans-serif">Rubik</option>
                                    <option value="'Cormorant', serif">Cormorant</option>
                                </select>
                                <input type="number" id="promo-title-size" class="input" value="80" min="10" max="180">
                                <input type="color" id="promo-title-color-picker" value="#000000">
                            </div>
                            <label>Текст акции</label>
                             <div class="setting-row">
                                <select id="promo-text-font-select" class="select">
                                   <option value="'Roboto', sans-serif">Roboto</option>
                                   <option value="'Open Sans', sans-serif">Open Sans</option>
                                   <option value="'PT Sans', sans-serif">PT Sans</option>
                                   <option value="'Playfair Display', serif">Playfair Display</option>
                                   <option value="'Montserrat', sans-serif">Montserrat</option>
                                   <option value="'Oswald', sans-serif">Oswald</option>
                                   <option value="'Raleway', sans-serif">Raleway</option>
                                   <option value="'Nunito', sans-serif">Nunito</option>
                                   <option value="'Rubik', sans-serif">Rubik</option>
                                   <option value="'Cormorant', serif">Cormorant</option>
                                </select>
                                <input type="number" id="promo-text-size" class="input" value="40" min="10" max="100">
                                <input type="color" id="promo-text-color-picker" value="#000000">
                            </div>
                        </div>
                    </details>
                    
                    <details class="control-group" open>
                        <summary>Настройки цены</summary>
                        <div class="control-group-content">
                            <div class="checkbox-group">
                                <input type="checkbox" id="promo-show-sml-prices-checkbox">
                                <label for="promo-show-sml-prices-checkbox">Показывать цены S,M,L</label>
                            </div>
                           <label>Цена</label>
                            <div class="setting-row">
                                <select id="promo-price-font-select" class="select">
                                    <option value="'Roboto', sans-serif">Roboto</option>
                                    <option value="'Open Sans', sans-serif">Open Sans</option>
                                    <option value="'PT Sans', sans-serif">PT Sans</option>
                                    <option value="'Playfair Display', serif">Playfair Display</option>
                                    <option value="'Montserrat', sans-serif">Montserrat</option>
                                    <option value="'Oswald', sans-serif">Oswald</option>
                                    <option value="'Raleway', sans-serif">Raleway</option>
                                    <option value="'Nunito', sans-serif">Nunito</option>
                                    <option value="'Rubik', sans-serif">Rubik</option>
                                    <option value="'Cormorant', serif">Cormorant</option>
                                </select>
                                <input type="number" id="promo-price-size" class="input" value="60" min="10" max="180">
                                <input type="color" id="promo-price-color-picker" value="#000000">
                            </div>
                            
                            <label>Скидка</label>
                            <div class="slider-container">
                                <input type="range" id="promo-discount-slider" min="0" max="100" value="0">
                                <div class="slider-value" id="promo-discount-value">0%</div>
                            </div>
                            <div class="setting-row">
                                <input type="color" id="discount-color-picker" value="#ff5252">
                                <input type="color" id="discount-bg-color-picker" value="rgba(255, 255, 255, 0.2)">
                            </div>
                        </div>
                    </details>
                    
                    <details class="control-group">
                        <summary>Оформление</summary>
                        <div class="control-group-content">
                            <label>Особенности</label>
                            <div class="features-group">
                                <div class="checkbox-group"><input type="checkbox" id="vegan-checkbox"><label for="vegan-checkbox">Веган</label></div>
                                <div class="checkbox-group"><input type="checkbox" id="halal-checkbox"><label for="halal-checkbox">Халяль</label></div>
                                <div class="checkbox-group"><input type="checkbox" id="glutenfree-checkbox"><label for="glutenfree-checkbox">Без глютена</label></div>
                                <div class="checkbox-group"><input type="checkbox" id="new-checkbox"><label for="new-checkbox">Новинка</label></div>
                            </div>
                            
                            <label style="margin-top:15px;">Выравнивание текста</label>
                            <select id="promo-text-align-select" class="select">
                                <option value="left">По левой стороне</option>
                                <option value="center">По центру</option>
                                <option value="right">По правой стороне</option>
                            </select>
                            
                            <label style="margin-top:15px;">Фон</label>
                             <select id="promo-bg-type-select" class="select">
                                <option value="color">Сплошной цвет</option>
                                <option value="image">Загрузить изображение</option>
                            </select>
                            <div id="bg-color-container">
                                <input type="color" id="bg-color-picker" value="#FFFFFF" style="width: 100%; height: 40px;">
                            </div>
                            <div id="bg-image-container" style="display: none;">
                                <button class="btn btn-secondary" onclick="document.getElementById('promo-background-upload').click()">Выберите файл</button>
                                <input type="file" id="promo-background-upload" accept="image/*" style="display: none;">
                                <div class="file-info" id="bg-file-info">Изображение не загружено</div>
                            </div>
                        </div>
                    </details>
                </div>
                
                <div id="combined-controls" style="display: none;">
                     <details class="control-group" open>
                        <summary>Настройки</summary>
                        <div class="control-group-content">
                           <p>Внесите нужные изменения в предыдущих разделах "Меню" и "Акция", ведь комбинированная страница, это совмещенный вариант уже созданных страниц.</p>
                        </div>
                    </details>
                </div>
            </div>
            
            <div class="controls-footer">
                <div class="btn-group">
                    <button class="btn" id="download-png-btn">Сохранить</button>
                    <button class="btn btn-secondary" id="download-mp4-btn">Сохранить видео</button>
                </div>
            </div>
        </div>
        
        <div class="preview-wrapper">
            <div class="preview-container" id="export-container">
                <div class="menu-preview" id="menu-preview">
                    <div style="text-align: center; color: #a3a9c2; padding: 40px; justify-content: center; height: 100%; display: flex; flex-direction: column;">
                        <h3>Здесь будет ваше меню</h3>
                        <p style="font-size: 14px; color: #a3a9c2">Настройте параметры слева и загрузите данные</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="aspect-ratio-modal" style="display: flex;">
        <div class="modal">
            <div class="modal-title">Выберите пропорции превью</div>
            <div class="aspect-ratio-buttons">
                <button class="aspect-ratio-btn active" data-ratio="16/9" data-width="1920" data-height="1080">16:9 (1920x1080)</button>
                <button class="aspect-ratio-btn" data-ratio="4/3" data-width="1600" data-height="1200">4:3 (1600x1200)</button>
                <button class="aspect-ratio-btn" data-ratio="3/2" data-width="1920" data-height="1280">3:2 (1920x1280)</button>
            </div>
            <div class="modal-actions">
                <button class="btn" id="confirm-aspect-ratio">Подтвердить</button>
            </div>
        </div>
    </div>
    
    <div class="modal-overlay" id="mp4-modal" style="display: none;">
        <div class="modal">
            <div class="modal-title">Сохранить как MP4</div>
            <input type="text" id="mp4-filename" class="input" placeholder="Имя файла (без расширения)" value="менюборд">
            <div class="setting-row">
                <label>Длительность (секунды):</label>
                <input type="number" id="mp4-duration" class="input" value="5" min="1" max="10">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-mp4">Отмена</button>
                <button class="btn" id="save-mp4">Сохранить</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="limit-modal" style="display: none;">
        <div class="modal">
            <div class="modal-title">Количество позиций в этой вёрстке ограничено настройками читаемости.</div>
            <div class="modal-actions" style="justify-content: center;">
                <button class="btn" id="limit-modal-close" style="width: 50%;">OK</button>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Генерация...</div>
    </div>
    
    <input type="file" id="grid-photo-upload" accept="image/*" style="display: none;">

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const getEl = (id) => document.getElementById(id);
            const controls = {
                tabButtons: document.querySelectorAll('.tab-btn'),
                menuControls: getEl('menu-controls'),
                promoControls: getEl('promo-controls'),
                combinedControls: getEl('combined-controls'),
                fileInput: getEl('file-input'),
                menuDropArea: getEl('menu-drop-area'),
                menuFileInfo: getEl('menu-file-info'),
                layoutButtons: getEl('layout-buttons'),
                showDescCheck: getEl('show-description-checkbox'),
                showDateCheck: getEl('show-date-checkbox'),
                showSmlPricesCheck: getEl('show-sml-prices-checkbox'),
                menuBgPicker: getEl('menu-bg-color-picker'),
                cellBgColorPicker: getEl('cell-bg-color-picker'),
                gridColorItems: document.querySelectorAll('.grid-color-item'),
                categoryFont: getEl('category-font-select'),
                categorySize: getEl('category-font-size'),
                categoryColor: getEl('category-color-picker'),
                itemFont: getEl('item-font-select'),
                itemSize: getEl('item-font-size'),
                itemColor: getEl('item-color-picker'),
                descFont: getEl('desc-font-select'),
                descSize: getEl('desc-font-size'),
                descColor: getEl('desc-color-picker'),
                priceFont: getEl('price-font-select'),
                priceSize: getEl('price-font-size'),
                priceColor: getEl('price-color-picker'),
                gridGradientSlider: getEl('grid-gradient-slider'),
                gridGradientValue: getEl('grid-gradient-value'),
                promoTitleSize: getEl('promo-title-size'),
                promoTitleColor: getEl('promo-title-color-picker'),
                promoTextSize: getEl('promo-text-size'),
                promoTextColor: getEl('promo-text-color-picker'),
                promoPriceSize: getEl('promo-price-size'),
                promoPriceColor: getEl('promo-price-color-picker'),
                promoDiscountSlider: getEl('promo-discount-slider'),
                promoDiscountValue: getEl('promo-discount-value'),
                discountColor: getEl('discount-color-picker'),
                discountBgColor: getEl('discount-bg-color-picker'),
                veganCheck: getEl('vegan-checkbox'),
                halalCheck: getEl('halal-checkbox'),
                glutenfreeCheck: getEl('glutenfree-checkbox'),
                newCheck: getEl('new-checkbox'),
                promoTextAlign: getEl('promo-text-align-select'),
                promoTitleFont: getEl('promo-title-font-select'),
                promoTextFont: getEl('promo-text-font-select'),
                promoPriceFont: getEl('promo-price-font-select'),
                promoBgType: getEl('promo-bg-type-select'),
                bgColorContainer: getEl('bg-color-container'),
                bgImageContainer: getEl('bg-image-container'),
                promoBgUpload: getEl('promo-background-upload'),
                promoBgInfo: getEl('bg-file-info'),
                bgColorPicker: getEl('bg-color-picker'),
                gridPhotoUpload: getEl('grid-photo-upload'),
                menuPreview: getEl('menu-preview'),
                exportContainer: getEl('export-container'),
                downloadPngBtn: getEl('download-png-btn'),
                downloadMp4Btn: getEl('download-mp4-btn'),
                loadingOverlay: getEl('loading-overlay'),
                loadingText: getEl('loading-text'),
                aspectRatioModal: getEl('aspect-ratio-modal'),
                aspectRatioBtns: document.querySelectorAll('.aspect-ratio-btn'),
                confirmAspectRatio: getEl('confirm-aspect-ratio'),
                mp4Modal: getEl('mp4-modal'),
                mp4Filename: getEl('mp4-filename'),
                mp4Duration: getEl('mp4-duration'),
                cancelMp4: getEl('cancel-mp4'),
                saveMp4: getEl('save-mp4'),
                toggleUpload: getEl('toggle-upload'),
                toggleManual: getEl('toggle-manual'),
                uploadModeContent: getEl('upload-mode-content'),
                manualModeContent: getEl('manual-mode-content'),
                manualItemList: getEl('manual-item-list'),
                addManualItemBtn: getEl('add-manual-item-btn'),
                exportExcelBtn: getEl('export-excel-btn'),
                menuBgOptions: getEl('menu-bg-options'),
                menuBgTypeSelect: getEl('menu-bg-type-select'),
                menuBgImageContainer: getEl('menu-bg-image-container'),
                menuBgUpload: getEl('menu-background-upload'),
                menuBgFileInfo: getEl('menu-bg-file-info'),
                limitModal: getEl('limit-modal'),
                limitModalClose: getEl('limit-modal-close'),
                promoShowSmlPricesCheck: getEl('promo-show-sml-prices-checkbox'),
            };

            let state = {
                currentTab: 'menu',
                layout: 'grid',
                excelData: [],
                promoTitle: 'Заголовок акции',
                promoText: 'Текст акции с описанием',
                promoPrice: '100',
                promoPriceS: '80',
                promoPriceM: '100',
                promoPriceL: '120',
                promoVolumeS: 'S',
                promoVolumeM: 'M',
                promoVolumeL: 'L',
                promoComment: 'Комментарий про акцию, сроки проведения и т.д.',
                promoBgImage: null,
                menuBgImage: null,
                gridImages: {},
                imageTransforms: {},
                currentGridTarget: null,
                aspectRatio: '16/9',
                exportWidth: 1920,
                exportHeight: 1080,
                displayDate: '',
                currency: '₽',
            };
            
            // --- Image Resizing and Panning State ---
            let activeResizable = {
                element: null,
                mode: null, // 'resize' or 'pan'
                handle: null, // 'tl', 'tr', 'bl', 'br'
                key: null,
                startX: 0,
                startY: 0,
                startSize: 100,
                startPosX: 50,
                startPosY: 50
            };

            function formatDate(date) {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            }

            function getContrastColor(hexcolor) {
                if (!hexcolor) return '#000000';
                if (hexcolor.startsWith('#')) {
                    hexcolor = hexcolor.slice(1);
                }
                if (hexcolor.length === 3) {
                    hexcolor = hexcolor.split('').map(hex => hex + hex).join('');
                }
                const r = parseInt(hexcolor.substring(0, 2), 16);
                const g = parseInt(hexcolor.substring(2, 4), 16);
                const b = parseInt(hexcolor.substring(4, 6), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#1A1D1F' : '#FFFFFF';
            }

            function createDefaultMenuData() {
                 if(state.excelData.length === 0) {
                     state.excelData = [
                        { name: 'Блюдо 1', description: 'Краткое описание блюда', price: '100', category: 'Название категории', S: '150', M: '200', L: '250', volumeS: 'S', volumeM: 'M', volumeL: 'L', isPlaceholder: true },
                        { name: 'Блюдо 2', description: 'Краткое описание блюда', price: '200', category: 'Название категории', S: '', M: '', L: '', isPlaceholder: true },
                        { name: 'Блюдо 3', description: 'Краткое описание блюда', price: '300', category: 'Название категории', S: '', M: '', L: '', isPlaceholder: true },
                        { name: 'Блюдо 4', description: 'Краткое описание блюда', price: '400', category: 'Название категории', S: '', M: '', L: '', isPlaceholder: true }
                     ];
                 }
            }

            function updateMenuBgControlsVisibility() {
                controls.menuBgImageContainer.style.display = controls.menuBgTypeSelect.value === 'image' ? 'block' : 'none';
                render();
            }

            function init() {
                state.displayDate = formatDate(new Date());
                setupEventListeners();
                const initialActiveBtn = document.querySelector('.aspect-ratio-btn.active');
                if (initialActiveBtn) {
                    state.aspectRatio = initialActiveBtn.dataset.ratio;
                    state.exportWidth = parseInt(initialActiveBtn.dataset.width);
                    state.exportHeight = parseInt(initialActiveBtn.dataset.height);
                    updatePreviewAspectRatio();
                }

                createDefaultMenuData();
                renderManualEditor();
                updateGridColorVisibility();
                updateMenuBgControlsVisibility();
                render();
            }

            function setupEventListeners() {
                document.body.addEventListener('input', (e) => {
                    const target = e.target;
                    const priceFields = ['price', 'promoPrice', 'S', 'M', 'L', 'promoPriceS', 'promoPriceM', 'promoPriceL'];
                    const isPriceField = priceFields.includes(target.dataset.field) && target.isContentEditable;
                    
                    if (isPriceField) {
                        let originalText = target.innerText;
                        let sanitizedText = originalText.replace(/[^\d.,]/g, '');
                        if (originalText !== sanitizedText) {
                            const selection = window.getSelection();
                            const range = selection.getRangeAt(0);
                            const cursorPosition = range.startOffset;

                            target.innerText = sanitizedText;

                            try {
                                const newRange = document.createRange();
                                const textNode = target.firstChild || '';
                                const newPosition = Math.min(cursorPosition, sanitizedText.length);
                                newRange.setStart(textNode, newPosition);
                                newRange.collapse(true);
                                selection.removeAllRanges();
                                selection.addRange(newRange);
                            } catch(err) { /* Silently fail if node is not found */ }
                        }
                    }
                });


                controls.tabButtons.forEach(btn => btn.addEventListener('click', () => {
                    state.currentTab = btn.dataset.tab;
                    controls.tabButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateTabVisibility();
                    render();
                }));

                setupDropArea(controls.menuDropArea, controls.fileInput, controls.menuFileInfo);

                controls.layoutButtons.addEventListener('click', (e) => {
                    const targetButton = e.target.closest('.layout-btn');
                    if (!targetButton) return;
                    state.layout = targetButton.dataset.layout;

                    document.querySelectorAll('#layout-buttons .layout-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    targetButton.classList.add('active');
                    
                    updateGridColorVisibility();
                    render();
                });

                document.querySelectorAll('.controls-panel input, .controls-panel select').forEach(el => {
                    el.addEventListener('input', render);
                    el.addEventListener('change', render);
                });
                
                controls.promoDiscountSlider.addEventListener('input', () => {
                    controls.promoDiscountValue.textContent = `${controls.promoDiscountSlider.value}%`;
                    render();
                });

                controls.gridGradientSlider.addEventListener('input', () => {
                    controls.gridGradientValue.textContent = `${controls.gridGradientSlider.value}%`;
                    render();
                });
                
                controls.promoBgType.addEventListener('change', updatePromoBgControls);
                controls.promoBgUpload.addEventListener('change', handlePromoBgUpload);
                controls.downloadPngBtn.addEventListener('click', downloadAsPNG);
                controls.downloadMp4Btn.addEventListener('click', showMp4Modal);
                controls.menuPreview.addEventListener('click', handleGridPhotoUploadClick);
                controls.gridPhotoUpload.addEventListener('change', handleGridPhotoFileChange);
                
                controls.menuPreview.addEventListener('focusin', e => {
                    const target = e.target;
                    if(target.classList.contains('is-placeholder')) {
                        target.innerText = '';
                        target.classList.remove('is-placeholder');
                        
                        const index = target.dataset.index;
                        if (index && state.excelData[index]) {
                            state.excelData[index].isPlaceholder = false;
                        }
                    }
                });

                controls.menuPreview.addEventListener('blur', handleInlineEdit, true);
                
                controls.aspectRatioBtns.forEach(btn => btn.addEventListener('click', () => {
                    controls.aspectRatioBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.aspectRatio = btn.dataset.ratio;
                    state.exportWidth = parseInt(btn.dataset.width);
                    state.exportHeight = parseInt(btn.dataset.height);
                    updatePreviewAspectRatio();
                }));
                
                controls.confirmAspectRatio.addEventListener('click', () => {
                    controls.aspectRatioModal.style.display = 'none';
                    render(); 
                });
                
                controls.cancelMp4.addEventListener('click', () => controls.mp4Modal.style.display = 'none');
                controls.saveMp4.addEventListener('click', downloadAsMP4);
                controls.toggleUpload.addEventListener('click', switchInputMode);
                controls.toggleManual.addEventListener('click', switchInputMode);
                controls.exportExcelBtn.addEventListener('click', exportToExcel);
                controls.manualItemList.addEventListener('click', handleManualEditorActions);
                controls.addManualItemBtn.addEventListener('click', addManualItem);
                
                controls.menuBgTypeSelect.addEventListener('change', updateMenuBgControlsVisibility);
                controls.menuBgUpload.addEventListener('change', handleMenuBgUpload);
                
                controls.limitModalClose.addEventListener('click', () => {
                    controls.limitModal.style.display = 'none';
                });

                // --- Image Resizing and Panning Listeners ---
                controls.menuPreview.addEventListener('mousedown', handlePreviewMouseDown);
                document.addEventListener('mousemove', handleDocumentMouseMove);
                document.addEventListener('mouseup', handleDocumentMouseUp);
                document.body.addEventListener('click', (e) => {
                    if (!controls.menuPreview.contains(e.target)) {
                       deselectActiveResizable();
                    }
                }, true);

                controls.menuPreview.addEventListener('click', handleDeletePhotoClick);
            }
            
             function handleDeletePhotoClick(e) {
                const deleteBtn = e.target.closest('.delete-photo-btn');
                if (!deleteBtn) return;
                
                e.preventDefault();
                e.stopPropagation();

                const index = deleteBtn.dataset.index;
                if (index !== undefined) {
                    delete state.gridImages[index];
                    const key = `grid-${index}`;
                    delete state.imageTransforms[key];
                    render();
                }
            }
            
            function handleMenuBgUpload(e) {
                if (e.target.files && e.target.files[0]) {
                    const file = e.target.files[0];
                    controls.menuBgFileInfo.textContent = file.name;
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        state.menuBgImage = event.target.result;
                        render();
                    };
                    reader.readAsDataURL(file);
                }
            }

            function updatePreviewAspectRatio() { controls.exportContainer.style.aspectRatio = state.aspectRatio; }

            function updateTabVisibility() {
                controls.menuControls.style.display = (state.currentTab === 'menu') ? 'block' : 'none';
                controls.promoControls.style.display = (state.currentTab === 'promo') ? 'block' : 'none';
                controls.combinedControls.style.display = (state.currentTab === 'combined') ? 'block' : 'none';
                updateGridColorVisibility();
            }
            
            function updateGridColorVisibility() {
                const show = state.layout === 'grid' || state.layout === 'grid3x2';
                 controls.gridColorItems.forEach(item => { item.style.display = show ? 'block' : 'none'; });
            }

            function updatePromoBgControls() {
                const type = controls.promoBgType.value;
                controls.bgColorContainer.style.display = type === 'color' ? 'block' : 'none';
                controls.bgImageContainer.style.display = type === 'image' ? 'block' : 'none';
                render();
            }

            function switchInputMode(e) {
                const mode = e.target.dataset.mode;
                controls.toggleUpload.classList.toggle('active', mode === 'upload');
                controls.toggleManual.classList.toggle('active', mode === 'manual');
                controls.uploadModeContent.style.display = mode === 'upload' ? 'block' : 'none';
                controls.manualModeContent.style.display = mode === 'manual' ? 'block' : 'none';
                if(mode === 'manual') {
                    state.layout = 'grid';
                    document.querySelectorAll('#layout-buttons .layout-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.layout === 'grid'));
                    createDefaultMenuData();
                    render();
                }
            }
            
            function addManualItem() {
                const limits = { grid: 4, grid3x2: 6, list: Infinity };
                const limit = limits[state.layout];
                
                if (limit && state.excelData.length >= limit) {
                    controls.limitModal.style.display = 'flex';
                    return;
                }

                const lastItem = state.excelData.length > 0 ? state.excelData[state.excelData.length - 1] : null;
                const newCategory = lastItem ? lastItem.category : 'Новая категория';
                
                const newItem = {
                    name: 'Новое блюдо',
                    description: 'Описание блюда',
                    price: '100',
                    category: newCategory,
                    S: '', M: '', L: '',
                    volumeS: 'S', volumeM: 'M', volumeL: 'L',
                    isPlaceholder: true // New items are also placeholders
                };
                state.excelData.push(newItem);
                renderManualEditor();
                render();
            }

            function setupDropArea(dropArea, fileInput, fileInfo) {
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); }, false);
                });
                ['dragenter', 'dragover'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight')));
                ['dragleave', 'drop'].forEach(eventName => dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight')));
                
                dropArea.addEventListener('drop', e => {
                    if (e.dataTransfer.files.length) { fileInput.files = e.dataTransfer.files; handleFile(e.dataTransfer.files[0]); }
                });
                fileInput.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]) });

                function handleFile(file) {
                    fileInfo.textContent = file.name;
                    if (file.name.match(/\.(xlsx|xls|csv)$/i)) { handleExcelFile(file); } 
                    else if (file.name.endsWith('.txt')) { handleTextFile(file); }
                    else { alert('Неподдерживаемый формат файла. Используйте Excel или TXT.'); }
                }
                
                function handleExcelFile(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet);
                            
                            const findValue = (obj, keys) => {
                                for (const key of keys) {
                                    const objKey = Object.keys(obj).find(k => k.toLowerCase() === key.toLowerCase());
                                    if (objKey && obj[objKey] !== undefined) return obj[objKey];
                                }
                                return '';
                            };
                            state.excelData = jsonData.map(row => ({
                                name: findValue(row, ['Название', 'Наименование', 'блюдо']), description: findValue(row, ['Описание', 'состав']),
                                price: findValue(row, ['Цена', 'Стоимость', 'с ндс']), photo: row['Фото'] || '',
                                category: (findValue(row, ['Категория', 'тип']) || 'Основное меню').trim(), 
                                S: findValue(row, ['S', 'Цена S']), 
                                M: findValue(row, ['M', 'Цена M']), 
                                L: findValue(row, ['L', 'Цена L']),
                                volumeS: findValue(row, ['Объем S', 'volumeS']) || 'S',
                                volumeM: findValue(row, ['Объем M', 'volumeM']) || 'M',
                                volumeL: findValue(row, ['Объем L', 'volumeL']) || 'L',
                                isPlaceholder: false // Data from file is not a placeholder
                            }));
                            state.gridImages = {};
                            state.imageTransforms = {};
                            render();
                            renderManualEditor();
                        } catch (error) { alert('Ошибка при чтении файла Excel: ' + error.message); }
                    };
                    reader.readAsArrayBuffer(file);
                }
                
                function handleTextFile(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const lines = e.target.result.split('\n');
                            let currentCategory = 'Основное меню';
                            state.excelData = lines.map(line => {
                                line = line.trim();
                                if (!line) return null;
                                if (line.startsWith('#') || line.startsWith('*') || line.endsWith(':')) {
                                    currentCategory = line.replace(/[#*:]/g, '').trim();
                                    return null;
                                }
                                const parts = line.split(' - ');
                                return { name: parts[0]?.trim() || '', description: parts[1]?.trim() || '', price: (parts[2]?.match(/(\d+)/) || [])[1] || parts[2]?.trim() || '', category: currentCategory, isPlaceholder: false };
                            }).filter(Boolean);
                            state.gridImages = {};
                            state.imageTransforms = {};
                            render();
                            renderManualEditor();
                        } catch (error) { alert('Ошибка при чтении TXT файла: ' + error.message); }
                    };
                    reader.readAsText(file);
                }
            }

            function renderManualEditor() {
                controls.manualItemList.innerHTML = state.excelData.map((item, index) => `
                    <div class="manual-item">
                        <span class="manual-item-name">${item.name}</span>
                        <div class="manual-item-actions">
                            <button class="delete-item-btn" data-index="${index}"><img src="delete.svg" alt="Удалить" style="width:32px;height:32px;"></button>
                        </div>
                    </div>
                `).join('');
            }
            
            function handleManualEditorActions(e) {
                const button = e.target.closest('.delete-item-btn');
                if (button) {
                    const index = parseInt(button.dataset.index, 10);
                    state.excelData.splice(index, 1);
                    render();
                    renderManualEditor();
                }
            }
            
            function handleInlineEdit(e) {
                const target = e.target;
                if (activeResizable.element || target.classList.contains('is-placeholder')) return;
                
                const field = target.dataset.field;
                if (!field) return;
                
                let newValue = target.innerText.trim();
                
                if (field.startsWith('promo')) {
                    state[field] = newValue;
                } else if (field === 'displayDate') {
                    state.displayDate = newValue;
                }
                else {
                    const index = target.dataset.index;
                    if (index === undefined) return;
                    const item = state.excelData[index];
                    if (!item) return;

                    item.isPlaceholder = false;

                    const priceFields = ['price', 'S', 'M', 'L'];
                     if (priceFields.includes(field)) {
                         item[field] = newValue.replace(/[^\d.,]/g, '').trim();
                         if (!newValue.includes(state.currency)) {
                            target.innerText = formatPrice(newValue);
                         }
                    } else if(field.startsWith('volume')) {
                        item[field] = newValue.replace(':', '').trim();
                    } else if (field === 'category') {
                         const oldCategory = item.category;
                         state.excelData.forEach(it => {
                            if (it.category === oldCategory) it.category = newValue
                         });
                    } else {
                         item[field] = newValue;
                    }
                }
                renderManualEditor();
            }

            function generateFilename() {
                const dateStr = formatDate(new Date()).replace(/\./g, '-');
                let categoryStr = (state.excelData.length > 0 ? state.excelData[0].category : 'меню').trim().replace(/\s+/g, '_');
                return `${categoryStr}_${dateStr}`;
            }

            function exportToExcel() {
                if (state.excelData.length === 0) { alert('Нет данных для экспорта'); return; }
                const wsData = state.excelData.map(item => ({
                    'Категория': item.category, 'Название': item.name, 'Описание': item.description,
                    'Стоимость': item.price, 
                    'Объем S': item.volumeS, 'Цена S': item.S, 
                    'Объем M': item.volumeM, 'Цена M': item.M, 
                    'Объем L': item.volumeL, 'Цена L': item.L
                }));
                const ws = XLSX.utils.json_to_sheet(wsData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Меню");
                XLSX.writeFile(wb, `${generateFilename()}.xlsx`);
            }

            function handlePromoBgUpload(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        state.promoBgImage = event.target.result;
                        state.imageTransforms['promo'] = { size: 100, x: 50, y: 50 };
                        render();
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            }

            function handleGridPhotoUploadClick(e) {
                const photoContainer = e.target.closest('.item-photo-container');
                 if (photoContainer && !photoContainer.querySelector('.item-photo')) {
                    state.currentGridTarget = photoContainer.dataset.index;
                    controls.gridPhotoUpload.click();
                }
            }

            function handleGridPhotoFileChange(e) {
                if (e.target.files && e.target.files[0] && state.currentGridTarget !== null) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        state.gridImages[state.currentGridTarget] = event.target.result;
                        const key = `grid-${state.currentGridTarget}`;
                        state.imageTransforms[key] = { size: 100, x: 50, y: 50 };
                        render(); 
                        state.currentGridTarget = null;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                    e.target.value = '';
                }
            }

            function formatPrice(price) {
                if (price === null || price === undefined || String(price).trim() === '') return '';
                const num = parseFloat(String(price).replace(',', '.'));
                return isNaN(num) ? price : `${num.toFixed(0)} ${state.currency}`;
            }

            function calculateDiscountedPrice() {
                const basePrice = parseFloat(state.promoPrice) || 0;
                const discount = parseFloat(controls.promoDiscountSlider.value) || 0;
                return basePrice * (1 - discount / 100);
            }

            function applyStyles() {
                const styles = {
                    '--menu-bg-color': controls.menuBgPicker.value, '--cell-bg-color': controls.cellBgColorPicker.value,
                    '--category-font-family': controls.categoryFont.value, '--category-font-size': controls.categorySize.value + 'px',
                    '--category-font-color': controls.categoryColor.value, '--item-font-family': controls.itemFont.value,
                    '--item-font-size': controls.itemSize.value + 'px', '--item-font-color': controls.itemColor.value,
                    '--desc-font-family': controls.descFont.value, '--desc-font-size': controls.descSize.value + 'px',
                    '--desc-font-color': controls.descColor.value, '--price-font-family': controls.priceFont.value,
                    '--price-font-size': controls.priceSize.value + 'px', '--price-font-color': controls.priceColor.value,
                    '--promo-title-font-family': controls.promoTitleFont.value, '--promo-title-font-size': controls.promoTitleSize.value + 'px',
                    '--promo-title-font-color': controls.promoTitleColor.value, '--promo-text-font-family': controls.promoTextFont.value,
                    '--promo-text-font-size': controls.promoTextSize.value + 'px', '--promo-text-font-color': controls.promoTextColor.value,
                    '--promo-price-font-family': controls.promoPriceFont.value, '--promo-price-font-size': controls.promoPriceSize.value + 'px',
                    '--promo-price-font-color': controls.promoPriceColor.value, '--discount-font-color': controls.discountColor.value,
                    '--discount-bg-color': controls.discountBgColor.value, '--promo-text-align': controls.promoTextAlign.value,
                    '--date-contrast-color': getContrastColor(controls.menuBgPicker.value),
                    '--grid-gradient-opacity': parseFloat(controls.gridGradientSlider.value) / 100,
                };
                for (const [key, value] of Object.entries(styles)) { document.documentElement.style.setProperty(key, value); }
            }
            
            function renderMenuHTML(currentLayout) {
                if (!state.excelData || state.excelData.length === 0) return '';
                
                const isList = currentLayout === 'list';
                let headerHTML = '';

                if (!isList) {
                    const firstCategory = state.excelData.length > 0 ? state.excelData[0].category : '';
                    const isFirstItemPlaceholder = state.excelData.length > 0 && state.excelData[0].isPlaceholder;
                    headerHTML = `
                        <div class="menu-header">
                            <div class="menu-grid-category-title ${isFirstItemPlaceholder ? 'is-placeholder' : ''}" contenteditable="true" data-index="0" data-field="category">${firstCategory}</div>
                            ${controls.showDateCheck.checked ? `<div class="menu-date auto-contrast" contenteditable="true" data-field="displayDate">${state.displayDate}</div>` : ''}
                        </div>`;
                }

                switch (currentLayout) {
                    case 'grid': return headerHTML + renderGridMenu(4, 'menu-grid-template');
                    case 'grid3x2': return headerHTML + renderGridMenu(6, 'menu-grid-template-3x2');
                    default: return renderListMenu();
                }
            }

            function renderListMenu() {
                const dataToRender = state.excelData;
                const categories = {};
                dataToRender.forEach(item => {
                    if (!categories[item.category]) categories[item.category] = [];
                    categories[item.category].push(item);
                });
                
                const dateHTML = controls.showDateCheck.checked ? `<div class="menu-header list-view-header"><div class="menu-date auto-contrast" contenteditable="true" data-field="displayDate">${state.displayDate}</div></div>` : '';

                let itemsHTML = Object.keys(categories).map(categoryName => {
                    const itemsInCategory = categories[categoryName];
                    const firstItemIndex = state.excelData.indexOf(itemsInCategory[0]);
                    const isCategoryPlaceholder = itemsInCategory[0] && itemsInCategory[0].isPlaceholder;

                    const smlHeader = controls.showSmlPricesCheck.checked ? `
                        <div class="list-price-headers">
                            <span>S</span>
                            <span>M</span>
                            <span>L</span>
                        </div>
                    ` : '';


                    return `
                    <div class="menu-section">
                        <div class="section-header">
                            <div class="section-title ${isCategoryPlaceholder ? 'is-placeholder' : ''}" contenteditable="true" data-index="${firstItemIndex}" data-field="category">${categoryName}</div>
                            ${smlHeader}
                        </div>
                        ${itemsInCategory.map(item => {
                            const originalIndex = state.excelData.indexOf(item);
                            const placeholderClass = item.isPlaceholder ? 'is-placeholder' : '';
                            let priceHTML;
                            if (controls.showSmlPricesCheck.checked) {
                                priceHTML = `<div class="volume-price-container">` +
                                    `<div class="volume-price"><span contenteditable="true" data-index="${originalIndex}" data-field="volumeS">${item.volumeS || 'S'}:</span><span contenteditable="true" data-index="${originalIndex}" data-field="S">${formatPrice(item.S || '') || '-'}</span></div>` +
                                    `<div class="volume-price"><span contenteditable="true" data-index="${originalIndex}" data-field="volumeM">${item.volumeM || 'M'}:</span><span contenteditable="true" data-index="${originalIndex}" data-field="M">${formatPrice(item.M || '') || '-'}</span></div>` +
                                    `<div class="volume-price"><span contenteditable="true" data-index="${originalIndex}" data-field="volumeL">${item.volumeL || 'L'}:</span><span contenteditable="true" data-index="${originalIndex}" data-field="L">${formatPrice(item.L || '') || '-'}</span></div>` +
                                `</div>`;
                            } else {
                                priceHTML = `<span contenteditable="true" class="${placeholderClass}" data-index="${originalIndex}" data-field="price">${formatPrice(item.price) || formatPrice('0')}</span>`;
                            }
                            return `
                            <div class="menu-item">
                                <div class="item-content">
                                    <div class="item-name ${placeholderClass}" contenteditable="true" data-index="${originalIndex}" data-field="name">${item.name}</div>
                                    ${controls.showDescCheck.checked ? `<div class="item-description ${placeholderClass}" contenteditable="true" data-index="${originalIndex}" data-field="description">${item.description || ''}</div>` : ''}
                                </div>
                                <div class="item-price">${priceHTML}</div>
                            </div>`;
                        }).join('')}
                    </div>`;
                }).join('');

                const columnsClass = state.excelData.length > 10 ? 'two-columns' : '';
                return `${dateHTML}<div class="menu-list-template"><div class="menu-items-container ${columnsClass}">${itemsHTML}</div></div>`;
            }
            
            function renderGridMenu(limit, className) {
                const renderCell = (item, index) => {
                    const originalIndex = state.excelData.indexOf(item);
                    const imgSrc = state.gridImages[originalIndex] || item.photo;
                    const placeholderClass = item.isPlaceholder ? 'is-placeholder' : '';
                    
                    const key = `grid-${originalIndex}`;
                    const transform = state.imageTransforms[key] || { size: 100, x: 50, y: 50 };
                    
                    const photoHTML = imgSrc ? `
                        <div class="item-photo" style="background-image: url('${imgSrc}');"></div>
                        <div class="resize-handle tl"></div>
                        <div class="resize-handle tr"></div>
                        <div class="resize-handle bl"></div>
                        <div class="resize-handle br"></div>
                        <button class="delete-photo-btn" data-index="${originalIndex}"><img src="delete.svg" alt="Удалить"></button>
                    ` : `<button class="upload-photo-btn">+</button>`;

                    let priceHTML;
                     if (controls.showSmlPricesCheck.checked) {
                        priceHTML = `<div class="volume-price-container">` +
                            `<div class="volume-price"><span contenteditable="true" data-index="${originalIndex}" data-field="volumeS">${item.volumeS || 'S'}:</span><span contenteditable="true" data-index="${originalIndex}" data-field="S">${formatPrice(item.S || '')}</span></div>` +
                            `<div class="volume-price"><span contenteditable="true" data-index="${originalIndex}" data-field="volumeM">${item.volumeM || 'M'}:</span><span contenteditable="true" data-index="${originalIndex}" data-field="M">${formatPrice(item.M || '')}</span></div>` +
                            `<div class="volume-price"><span contenteditable="true" data-index="${originalIndex}" data-field="volumeL">${item.volumeL || 'L'}:</span><span contenteditable="true" data-index="${originalIndex}" data-field="L">${formatPrice(item.L || '')}</span></div>` +
                        `</div>`;
                    } else {
                        priceHTML = `<span contenteditable="true" class="${placeholderClass}" data-index="${originalIndex}" data-field="price">${formatPrice(item.price) || formatPrice('0')}</span>`;
                    }
                    
                    return `
                    <div class="grid-cell">
                        <div class="grid-gradient-overlay"></div>
                        <div class="grid-cell-content">
                            <div class="item-name ${placeholderClass}" contenteditable="true" data-index="${originalIndex}" data-field="name">${item.name}</div>
                            ${controls.showDescCheck.checked ? `<div class="item-description ${placeholderClass}" contenteditable="true" data-index="${originalIndex}" data-field="description">${item.description || ''}</div>` : '<div></div>'}
                            <div class="item-price">${priceHTML}</div>
                        </div>
                        <div class="item-photo-container resizable-container" data-index="${originalIndex}" data-key="${key}">
                            ${photoHTML}
                        </div>
                    </div>`;
                };
                return `<div class="${className}">${state.excelData.slice(0, limit).map(renderCell).join('')}</div>`;
            }

            function renderPromoHTML() {
                let priceHTML = '';

                if (controls.promoShowSmlPricesCheck.checked) {
                    const textAlign = controls.promoTextAlign.value;
                    const justification = textAlign === 'center' ? 'center' : (textAlign === 'right' ? 'flex-end' : 'flex-start');
                    priceHTML = `
                        <style>
                            .promo-sml-prices { flex-direction: column; align-items: ${justification}; gap: 8px; }
                            .promo-sml-prices .volume-price {
                                font-size: calc(var(--promo-price-font-size) * 0.7);
                                color: var(--promo-price-font-color);
                                font-family: var(--promo-price-font-family);
                                font-weight: bold;
                                gap: 10px;
                                width: 100%;
                                justify-content: ${justification};
                            }
                            .promo-sml-prices .volume-price span:first-child { font-weight: 500; }
                        </style>
                        <div class="promo-price-container promo-sml-prices">
                            <div class="volume-price">
                                <span contenteditable="true" data-field="promoVolumeS">${state.promoVolumeS || 'S'}:</span>
                                <span contenteditable="true" data-field="promoPriceS">${formatPrice(state.promoPriceS)}</span>
                            </div>
                            <div class="volume-price">
                                <span contenteditable="true" data-field="promoVolumeM">${state.promoVolumeM || 'M'}:</span>
                                <span contenteditable="true" data-field="promoPriceM">${formatPrice(state.promoPriceM)}</span>
                            </div>
                            <div class="volume-price">
                                <span contenteditable="true" data-field="promoVolumeL">${state.promoVolumeL || 'L'}:</span>
                                <span contenteditable="true" data-field="promoPriceL">${formatPrice(state.promoPriceL)}</span>
                            </div>
                        </div>`;
                } else {
                    const discountedPrice = calculateDiscountedPrice();
                    priceHTML = discountedPrice > 0 ? `
                    <div class="promo-price-container">
                        <div class="promo-price" contenteditable="true" data-field="promoPrice">${formatPrice(state.promoPrice)}</div>
                        ${controls.promoDiscountSlider.value > 0 ? `<div class="promo-discount">-${controls.promoDiscountSlider.value}%</div>` : ''}
                    </div>` : '';
                }

                const createIcon = (src, alt) => `<span class="promo-icon-wrapper"><img src="${src}" alt="${alt}" class="promo-icon"></span>`;

                const iconsHTML = [
                    controls.veganCheck.checked && createIcon("vegan.svg", "Веган"),
                    controls.halalCheck.checked && createIcon("halal.svg", "Халяль"),
                    controls.glutenfreeCheck.checked && createIcon("glutenfree.svg", "Без глютена"),
                    controls.newCheck.checked && createIcon("new.svg", "Новинка")
                ].filter(Boolean).join('');

                return `
                    <div class="promo-content" style="text-align: ${controls.promoTextAlign.value};">
                        <div>
                           <div class="promo-title" contenteditable="true" data-field="promoTitle">${state.promoTitle}${iconsHTML}</div>
                           <div class="promo-text" contenteditable="true" data-field="promoText">${state.promoText}</div>
                           ${priceHTML}
                        </div>
                        <div class="promo-comment" contenteditable="true" data-field="promoComment">${state.promoComment}</div>
                    </div>`;
            }


            function render() {
                deselectActiveResizable();
                applyStyles();
                let html = '';
                const isMenuEmpty = !state.excelData || state.excelData.length === 0;
                
                if (state.currentTab === 'menu' && isMenuEmpty) {
                    controls.menuPreview.innerHTML = `
                    <div style="text-align: center; color: #a3a9c2; padding: 40px; justify-content: center; height: 100%; display: flex; flex-direction: column;">
                        <h3>Здесь будет ваше меню</h3><p style="font-size: 14px; color: #a3a9c2">Настройте параметры слева и загрузите данные</p>
                    </div>`;
                    return;
                }

                if (state.currentTab === 'menu') {
                    html = renderMenuHTML(state.layout);
                } else if (state.currentTab === 'promo') {
                    const promoContainer = document.createElement('div');
                    promoContainer.className = 'promo-template';
                    promoContainer.dataset.key = 'promo';
                    promoContainer.innerHTML = renderPromoHTML();
                    html = promoContainer.outerHTML;
                } else if (state.currentTab === 'combined') {
                    const menuHTML = `<div class="combined-menu-part">${renderMenuHTML(state.layout)}</div>`;
                    const promoHTML = `<div class="combined-promo-part" data-key="promo">${renderPromoHTML()}</div>`;
                    html = `<div class="combined-template">${menuHTML}${promoHTML}</div>`;
                }
                
                controls.menuPreview.innerHTML = html;
                
                controls.menuPreview.style.backgroundImage = 'none';

                let menuBgTarget = null;
                if (state.currentTab === 'menu') {
                    menuBgTarget = controls.menuPreview;
                } else if (state.currentTab === 'combined') {
                    menuBgTarget = controls.menuPreview.querySelector('.combined-menu-part');
                }

                if (menuBgTarget) {
                    if (controls.menuBgTypeSelect.value === 'image' && state.menuBgImage) {
                        menuBgTarget.style.backgroundImage = `url(${state.menuBgImage})`;
                        menuBgTarget.style.backgroundColor = '';
                    } else {
                        menuBgTarget.style.backgroundImage = 'none';
                        menuBgTarget.style.backgroundColor = controls.menuBgPicker.value;
                    }
                }

                if (state.currentTab === 'promo' || state.currentTab === 'combined') {
                    setPromoBackground(document.querySelector('.promo-template, .combined-promo-part'));
                }
            }


            function setPromoBackground(element) {
                if(!element) return;
                const type = controls.promoBgType.value;
                const transform = state.imageTransforms['promo'] || { size: 100, x: 50, y: 50 };

                if (type === 'image' && state.promoBgImage) {
                    element.style.backgroundImage = `url(${state.promoBgImage})`;
                    element.style.backgroundSize = `${transform.size}%`;
                    element.style.backgroundPosition = `${transform.x}% ${transform.y}%`;
                    element.style.backgroundColor = '';

                    element.classList.add('resizable-container');
                    if (!element.querySelector('.resize-handle')) {
                        const handles = ['tl', 'tr', 'bl', 'br'];
                        handles.forEach(h => {
                            const handle = document.createElement('div');
                            handle.className = `resize-handle ${h}`;
                            element.appendChild(handle);
                        });
                    }
                } else {
                    element.style.backgroundColor = controls.bgColorPicker.value;
                    element.style.backgroundImage = 'none';
                    element.classList.remove('resizable-container');
                    element.querySelectorAll('.resize-handle').forEach(h => h.remove());
                }
            }
            
            function download(callback) {
                deselectActiveResizable();
                controls.loadingText.textContent = 'Подготовка к сохранению...';
                controls.loadingOverlay.style.display = 'flex';

                const originalPreview = getEl('menu-preview');
                const captureClone = originalPreview.cloneNode(true);

                captureClone.querySelectorAll('.resize-handle, .upload-photo-btn, .delete-photo-btn').forEach(el => el.style.display = 'none');
                captureClone.querySelectorAll('.selected').forEach(s => s.classList.remove('selected'));

                const captureContainer = document.createElement('div');
                captureContainer.style.position = 'absolute';
                captureContainer.style.left = '-9999px';
                captureContainer.style.top = '0px';
                captureContainer.style.width = state.exportWidth + 'px';
                captureContainer.style.height = state.exportHeight + 'px';
                captureContainer.style.overflow = 'hidden';

                if (originalPreview.offsetWidth > 0) {
                    const wrapper = document.createElement('div');
                    wrapper.style.width = originalPreview.offsetWidth + 'px';
                    wrapper.style.height = originalPreview.offsetHeight + 'px';
                    wrapper.style.position = 'absolute';
                    wrapper.style.top = '0';
                    wrapper.style.left = '0';
                    
                    const scaleFactor = state.exportWidth / originalPreview.offsetWidth;
                    wrapper.style.transform = `scale(${scaleFactor})`;
                    wrapper.style.transformOrigin = 'top left';
                    
                    wrapper.appendChild(captureClone);
                    captureContainer.appendChild(wrapper);
                } else {
                     captureContainer.appendChild(captureClone);
                }

                document.body.appendChild(captureContainer);

                setTimeout(() => {
                    html2canvas(captureContainer, {
                        scale: 1, 
                        width: state.exportWidth,
                        height: state.exportHeight,
                        useCORS: true,
                        backgroundColor: null,
                        logging: false
                    }).then(canvas => {
                        callback(canvas);
                    }).catch(err => {
                        console.error('Error during export:', err);
                        alert('An error occurred during export: ' + err.message);
                    }).finally(() => {
                        document.body.removeChild(captureContainer);
                    });
                }, 500);
            }

            function downloadAsPNG() {
                download(canvas => {
                    canvas.toBlob(blob => {
                        saveAs(blob, `${generateFilename()}.png`);
                        controls.loadingOverlay.style.display = 'none';
                    }, 'image/png');
                });
            }
            
            function showMp4Modal() { controls.mp4Modal.style.display = 'flex'; }
            
            function downloadAsMP4() {
                const filenameBase = (controls.mp4Filename.value || generateFilename()).trim().replace(/\s+/g, '_');
                const duration = Math.max(1, Math.min(10, parseInt(controls.mp4Duration.value, 10) || 5));
                controls.mp4Modal.style.display = 'none';
                
                download(sourceCanvas => {
                    controls.loadingText.textContent = 'Сохраняем видео, это может занять время...';
                    
                    const videoCanvas = document.createElement('canvas');
                    videoCanvas.width = sourceCanvas.width;
                    videoCanvas.height = sourceCanvas.height;
                    const ctx = videoCanvas.getContext('2d');

                    const stream = videoCanvas.captureStream(30);
                    const mimeType = ['video/mp4', 'video/webm;codecs=vp9', 'video/webm'].find(MediaRecorder.isTypeSupported);
                    
                    if (!mimeType) { 
                        alert('Ваш браузер не поддерживает запись видео в формате MP4 или WebM.');
                        controls.loadingOverlay.style.display = 'none';
                        return;
                    }
                    
                    const recorder = new MediaRecorder(stream, { mimeType });
                    const recordedChunks = [];
                    recorder.ondataavailable = e => { if (e.data.size > 0) recordedChunks.push(e.data); };
                    
                    recorder.onstop = () => {
                        const blob = new Blob(recordedChunks, { type: mimeType });
                        saveAs(blob, `${generateFilename()}.mp4`);
                        controls.loadingOverlay.style.display = 'none';
                    };

                    recorder.start();

                    let startTime = null;
                    const animate = (timestamp) => {
                        if (!startTime) startTime = timestamp;
                        const elapsed = timestamp - startTime;
                        
                        ctx.drawImage(sourceCanvas, 0, 0);

                        if (elapsed < duration * 1000) {
                            requestAnimationFrame(animate);
                        } else {
                            recorder.stop();
                        }
                    };
                    
                    requestAnimationFrame(animate);
                });
            }
            
            // --- Image Resizing and Panning Functions ---
            function deselectActiveResizable() {
                const selected = controls.menuPreview.querySelector('.selected');
                if (selected) {
                    selected.classList.remove('selected');
                }
                activeResizable.element = null;
            }

            function handlePreviewMouseDown(e) {
                if (e.target.closest('[contenteditable="true"]')) {
                    return;
                }
                const handle = e.target.closest('.resize-handle');
                const container = e.target.closest('.resizable-container');

                if (!container) {
                    deselectActiveResizable();
                    return;
                }

                if (activeResizable.element !== container) {
                    deselectActiveResizable();
                    container.classList.add('selected');
                }

                e.preventDefault();
                e.stopPropagation();

                const key = container.dataset.key;
                if (!state.imageTransforms[key]) {
                    state.imageTransforms[key] = { size: 100, x: 50, y: 50 };
                }
                
                activeResizable = {
                    element: container,
                    key: key,
                    startX: e.clientX,
                    startY: e.clientY,
                    startSize: state.imageTransforms[key].size,
                    startPosX: state.imageTransforms[key].x,
                    startPosY: state.imageTransforms[key].y,
                };

                if (handle) {
                    activeResizable.mode = 'resize';
                    if (handle.classList.contains('br')) activeResizable.handle = 'br';
                    else if (handle.classList.contains('bl')) activeResizable.handle = 'bl';
                    else if (handle.classList.contains('tr')) activeResizable.handle = 'tr';
                    else if (handle.classList.contains('tl')) activeResizable.handle = 'tl';
                } else {
                    activeResizable.mode = 'pan';
                }
            }

            function handleDocumentMouseMove(e) {
                if (!activeResizable.element) return;
                
                e.preventDefault();
                e.stopPropagation();

                const dx = e.clientX - activeResizable.startX;
                const dy = e.clientY - activeResizable.startY;
                
                const transform = state.imageTransforms[activeResizable.key];
                
                const elementToStyle = activeResizable.element.matches('.item-photo-container') 
                    ? activeResizable.element.querySelector('.item-photo') 
                    : activeResizable.element;

                if (activeResizable.mode === 'resize') {
                    let sizeChange = 0;
                    const sensitivity = 0.4;

                    switch (activeResizable.handle) {
                        case 'br': sizeChange = (dx + dy) * sensitivity; break;
                        case 'bl': sizeChange = (dy - dx) * sensitivity; break;
                        case 'tr': sizeChange = (dx - dy) * sensitivity; break;
                        case 'tl': sizeChange = (-dx - dy) * sensitivity; break;
                    }
                    
                    const newSize = Math.max(50, Math.min(500, activeResizable.startSize + sizeChange));
                    transform.size = newSize;

                    if (elementToStyle) {
                        if (activeResizable.element.matches('.item-photo-container')) {
                             elementToStyle.style.backgroundSize = `auto ${newSize}%`;
                        } else {
                             elementToStyle.style.backgroundSize = `${newSize}%`;
                        }
                    }

                } else if (activeResizable.mode === 'pan') {
                    const sensitivity = 50 / activeResizable.element.offsetHeight;
                    let newX = activeResizable.startPosX - (dx * sensitivity);
                    let newY = activeResizable.startPosY - (dy * sensitivity);

                    transform.x = newX;
                    transform.y = newY;
                    
                    if (elementToStyle) elementToStyle.style.backgroundPosition = `${newX}% ${newY}%`;
                }
            }

            function handleDocumentMouseUp(e) {
                if (!activeResizable.element) return;
                e.preventDefault();
                e.stopPropagation();
                activeResizable.mode = null;
                activeResizable.handle = null;
            }

            init();
        });
    </script>
</body>
</html>
